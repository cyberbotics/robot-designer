"use strict";THREE.OrbitControls=function(e,t){var R=Math.sqrt,D=Math.max,A=Math.min,L=Math.pow,V=Math.PI;function o(){return 2*V/60/60*j.autoRotateSpeed}function r(){return L(.95,j.zoomSpeed)}function a(e){G.theta-=e}function n(e){G.phi-=e}function i(e){j.object.isPerspectiveCamera?Q/=e:j.object.isOrthographicCamera?(j.object.zoom=D(j.minZoom,A(j.maxZoom,j.object.zoom*e)),j.object.updateProjectionMatrix(),H=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),j.enableZoom=!1)}function l(e){j.object.isPerspectiveCamera?Q*=e:j.object.isOrthographicCamera?(j.object.zoom=D(j.minZoom,A(j.maxZoom,j.object.zoom/e)),j.object.updateProjectionMatrix(),H=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),j.enableZoom=!1)}function s(e){q.set(e.clientX,e.clientY)}function d(e){ee.set(e.clientX,e.clientY)}function c(e){K.set(e.clientX,e.clientY)}function u(e){I.set(e.clientX,e.clientY),W.subVectors(I,q).multiplyScalar(j.rotateSpeed);var t=j.domElement===document?j.domElement.body:j.domElement;a(2*V*W.x/t.clientHeight),n(2*V*W.y/t.clientHeight),q.copy(I),j.update()}function p(e){te.set(e.clientX,e.clientY),oe.subVectors(te,ee),0<oe.y?i(r()):0>oe.y&&l(r()),ee.copy(te),j.update()}function m(e){J.set(e.clientX,e.clientY),$.subVectors(J,K).multiplyScalar(j.panSpeed),ne($.x,$.y),K.copy(J),j.update()}function g(){}function f(e){0>e.deltaY?l(r()):0<e.deltaY&&i(r()),j.update()}function b(e){var t=!1;switch(e.keyCode){case j.keys.UP:ne(0,j.keyPanSpeed),t=!0;break;case j.keys.BOTTOM:ne(0,-j.keyPanSpeed),t=!0;break;case j.keys.LEFT:ne(j.keyPanSpeed,0),t=!0;break;case j.keys.RIGHT:ne(-j.keyPanSpeed,0),t=!0;}t&&(e.preventDefault(),j.update())}function y(e){q.set(e.touches[0].pageX,e.touches[0].pageY)}function h(e){if(j.enableZoom){var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,r=R(t*t+o*o);ee.set(0,r)}if(j.enablePan){var a=.5*(e.touches[0].pageX+e.touches[1].pageX),n=.5*(e.touches[0].pageY+e.touches[1].pageY);K.set(a,n)}}function v(e){I.set(e.touches[0].pageX,e.touches[0].pageY),W.subVectors(I,q).multiplyScalar(j.rotateSpeed);var t=j.domElement===document?j.domElement.body:j.domElement;a(2*V*W.x/t.clientHeight),n(2*V*W.y/t.clientHeight),q.copy(I),j.update()}function P(e){if(j.enableZoom){var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,r=R(t*t+o*o);te.set(0,r),oe.set(0,L(te.y/ee.y,j.zoomSpeed)),i(oe.y),ee.copy(te)}if(j.enablePan){var a=.5*(e.touches[0].pageX+e.touches[1].pageX),n=.5*(e.touches[0].pageY+e.touches[1].pageY);J.set(a,n),$.subVectors(J,K).multiplyScalar(j.panSpeed),ne($.x,$.y),K.copy(J)}j.update()}function x(){}function T(e){if(!1!==j.enabled){switch(e.preventDefault(),j.domElement.focus?j.domElement.focus():window.focus(),e.button){case j.mouseButtons.LEFT:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===j.enablePan)return;c(e),_=X.PAN}else{if(!1===j.enableRotate)return;s(e),_=X.ROTATE}break;case j.mouseButtons.MIDDLE:if(!1===j.enableZoom)return;d(e),_=X.DOLLY;break;case j.mouseButtons.RIGHT:if(!1===j.enablePan)return;c(e),_=X.PAN;}_!==X.NONE&&(document.addEventListener("mousemove",S,!1),document.addEventListener("mouseup",E,!1),j.dispatchEvent(z))}}function S(e){if(!1!==j.enabled)switch(e.preventDefault(),_){case X.ROTATE:if(!1===j.enableRotate)return;u(e);break;case X.DOLLY:if(!1===j.enableZoom)return;p(e);break;case X.PAN:if(!1===j.enablePan)return;m(e);}}function E(e){!1===j.enabled||(g(e),document.removeEventListener("mousemove",S,!1),document.removeEventListener("mouseup",E,!1),j.dispatchEvent(Y),_=X.NONE)}function M(e){!1===j.enabled||!1===j.enableZoom||_!==X.NONE&&_!==X.ROTATE||(e.preventDefault(),e.stopPropagation(),j.dispatchEvent(z),f(e),j.dispatchEvent(Y))}function w(e){!1===j.enabled||!1===j.enableKeys||!1===j.enablePan||b(e)}function C(e){if(!1!==j.enabled){switch(e.preventDefault(),e.touches.length){case 1:if(!1===j.enableRotate)return;y(e),_=X.TOUCH_ROTATE;break;case 2:if(!1===j.enableZoom&&!1===j.enablePan)return;h(e),_=X.TOUCH_DOLLY_PAN;break;default:_=X.NONE;}_!==X.NONE&&j.dispatchEvent(z)}}function k(e){if(!1!==j.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===j.enableRotate)return;if(_!==X.TOUCH_ROTATE)return;v(e);break;case 2:if(!1===j.enableZoom&&!1===j.enablePan)return;if(_!==X.TOUCH_DOLLY_PAN)return;P(e);break;default:_=X.NONE;}}function O(e){!1===j.enabled||(x(e),j.dispatchEvent(Y),_=X.NONE)}function B(e){!1===j.enabled||e.preventDefault()}this.object=e,this.domElement=t===void 0?document:t,this.enabled=!0,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=V,this.minAzimuthAngle=-Infinity,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={LEFT:THREE.MOUSE.LEFT,MIDDLE:THREE.MOUSE.MIDDLE,RIGHT:THREE.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return F.phi},this.getAzimuthalAngle=function(){return F.theta},this.saveState=function(){j.target0.copy(j.target),j.position0.copy(j.object.position),j.zoom0=j.object.zoom},this.reset=function(){j.target.copy(j.target0),j.object.position.copy(j.position0),j.object.zoom=j.zoom0,j.object.updateProjectionMatrix(),j.dispatchEvent(N),j.update(),_=X.NONE},this.update=function(){var t=new THREE.Vector3,r=new THREE.Quaternion().setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),n=r.clone().inverse(),i=new THREE.Vector3,l=new THREE.Quaternion;return function(){var e=j.object.position;return t.copy(e).sub(j.target),t.applyQuaternion(r),F.setFromVector3(t),j.autoRotate&&_===X.NONE&&a(o()),F.theta+=G.theta,F.phi+=G.phi,F.theta=D(j.minAzimuthAngle,A(j.maxAzimuthAngle,F.theta)),F.phi=D(j.minPolarAngle,A(j.maxPolarAngle,F.phi)),F.makeSafe(),F.radius*=Q,F.radius=D(j.minDistance,A(j.maxDistance,F.radius)),j.target.add(U),t.setFromSpherical(F),t.applyQuaternion(n),e.copy(j.target).add(t),j.object.lookAt(j.target),!0===j.enableDamping?(G.theta*=1-j.dampingFactor,G.phi*=1-j.dampingFactor,U.multiplyScalar(1-j.dampingFactor)):(G.set(0,0,0),U.set(0,0,0)),Q=1,!!(H||i.distanceToSquared(j.object.position)>Z||8*(1-l.dot(j.object.quaternion))>Z)&&(j.dispatchEvent(N),i.copy(j.object.position),l.copy(j.object.quaternion),H=!1,!0)}}(),this.dispose=function(){j.domElement.removeEventListener("contextmenu",B,!1),j.domElement.removeEventListener("mousedown",T,!1),j.domElement.removeEventListener("wheel",M,!1),j.domElement.removeEventListener("touchstart",C,!1),j.domElement.removeEventListener("touchend",O,!1),j.domElement.removeEventListener("touchmove",k,!1),document.removeEventListener("mousemove",S,!1),document.removeEventListener("mouseup",E,!1),window.removeEventListener("keydown",w,!1)};var j=this,N={type:"change"},z={type:"start"},Y={type:"end"},X={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY_PAN:4},_=X.NONE,Z=1e-6,F=new THREE.Spherical,G=new THREE.Spherical,Q=1,U=new THREE.Vector3,H=!1,q=new THREE.Vector2,I=new THREE.Vector2,W=new THREE.Vector2,K=new THREE.Vector2,J=new THREE.Vector2,$=new THREE.Vector2,ee=new THREE.Vector2,te=new THREE.Vector2,oe=new THREE.Vector2,re=function(){var e=new THREE.Vector3;return function(t,o){e.setFromMatrixColumn(o,0),e.multiplyScalar(-t),U.add(e)}}(),ae=function(){var e=new THREE.Vector3;return function(t,o){!0===j.screenSpacePanning?e.setFromMatrixColumn(o,1):(e.setFromMatrixColumn(o,0),e.crossVectors(j.object.up,e)),e.multiplyScalar(t),U.add(e)}}(),ne=function(){var e=new THREE.Vector3;return function(t,o){var r=j.domElement===document?j.domElement.body:j.domElement;if(j.object.isPerspectiveCamera){var a=j.object.position;e.copy(a).sub(j.target);var n=e.length();n*=Math.tan(j.object.fov/2*V/180),re(2*t*n/r.clientHeight,j.object.matrix),ae(2*o*n/r.clientHeight,j.object.matrix)}else j.object.isOrthographicCamera?(re(t*(j.object.right-j.object.left)/j.object.zoom/r.clientWidth,j.object.matrix),ae(o*(j.object.top-j.object.bottom)/j.object.zoom/r.clientHeight,j.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),j.enablePan=!1)}}();j.domElement.addEventListener("contextmenu",B,!1),j.domElement.addEventListener("mousedown",T,!1),j.domElement.addEventListener("wheel",M,!1),j.domElement.addEventListener("touchstart",C,!1),j.domElement.addEventListener("touchend",O,!1),j.domElement.addEventListener("touchmove",k,!1),window.addEventListener("keydown",w,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}}),"use strict";function toggleFullScreen(){(!document.fullScreenElement||null===document.fullScreenElement)&&(document.mozFullScreen||document.webkitIsFullScreen)?document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():document.documentElement.requestFullScreen?document.documentElement.requestFullScreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullScreen&&document.documentElement.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var Observable=function(){function e(){_classCallCheck(this,e),this.observers=new Map}return _createClass(e,[{key:"addObserver",value:function(e,t){this.observers.has(e)||this.observers.set(e,[]),this.observers.get(e).push(t)}},{key:"notify",value:function(t,o){var e=this.observers.get(t);e&&e.length&&e.forEach(function(e){e(o)})}}]),e}();"use strict",THREE.OutlinePass=function(e,t,o,r){var a=Math.round;this.renderScene=t,this.renderCamera=o,this.selectedObjects=r===void 0?[]:r,this.visibleEdgeColor=new THREE.Color(1,1,1),this.hiddenEdgeColor=new THREE.Color(.1,.04,.02),this.edgeGlow=0,this.usePatternTexture=!1,this.edgeThickness=1,this.edgeStrength=3,this.downSampleRatio=2,this.pulsePeriod=0,THREE.Pass.call(this),this.resolution=e===void 0?new THREE.Vector2(256,256):new THREE.Vector2(e.x,e.y);var n={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat},i=a(this.resolution.x/this.downSampleRatio),l=a(this.resolution.y/this.downSampleRatio);this.maskBufferMaterial=new THREE.MeshBasicMaterial({color:16777215}),this.maskBufferMaterial.side=THREE.DoubleSide,this.renderTargetMaskBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,n),this.renderTargetMaskBuffer.texture.name="OutlinePass.mask",this.renderTargetMaskBuffer.texture.generateMipmaps=!1,this.depthMaterial=new THREE.MeshDepthMaterial,this.depthMaterial.side=THREE.DoubleSide,this.depthMaterial.depthPacking=THREE.RGBADepthPacking,this.depthMaterial.blending=THREE.NoBlending,this.prepareMaskMaterial=this.getPrepareMaskMaterial(),this.prepareMaskMaterial.side=THREE.DoubleSide,this.prepareMaskMaterial.fragmentShader=function(e,t){var o=t.isPerspectiveCamera?"perspective":"orthographic";return e.replace(/DEPTH_TO_VIEW_Z/g,o+"DepthToViewZ")}(this.prepareMaskMaterial.fragmentShader,this.renderCamera),this.renderTargetDepthBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,n),this.renderTargetDepthBuffer.texture.name="OutlinePass.depth",this.renderTargetDepthBuffer.texture.generateMipmaps=!1,this.renderTargetMaskDownSampleBuffer=new THREE.WebGLRenderTarget(i,l,n),this.renderTargetMaskDownSampleBuffer.texture.name="OutlinePass.depthDownSample",this.renderTargetMaskDownSampleBuffer.texture.generateMipmaps=!1,this.renderTargetBlurBuffer1=new THREE.WebGLRenderTarget(i,l,n),this.renderTargetBlurBuffer1.texture.name="OutlinePass.blur1",this.renderTargetBlurBuffer1.texture.generateMipmaps=!1,this.renderTargetBlurBuffer2=new THREE.WebGLRenderTarget(a(i/2),a(l/2),n),this.renderTargetBlurBuffer2.texture.name="OutlinePass.blur2",this.renderTargetBlurBuffer2.texture.generateMipmaps=!1,this.edgeDetectionMaterial=this.getEdgeDetectionMaterial(),this.renderTargetEdgeBuffer1=new THREE.WebGLRenderTarget(i,l,n),this.renderTargetEdgeBuffer1.texture.name="OutlinePass.edge1",this.renderTargetEdgeBuffer1.texture.generateMipmaps=!1,this.renderTargetEdgeBuffer2=new THREE.WebGLRenderTarget(a(i/2),a(l/2),n),this.renderTargetEdgeBuffer2.texture.name="OutlinePass.edge2",this.renderTargetEdgeBuffer2.texture.generateMipmaps=!1;var s=4;this.separableBlurMaterial1=this.getSeperableBlurMaterial(4),this.separableBlurMaterial1.uniforms.texSize.value=new THREE.Vector2(i,l),this.separableBlurMaterial1.uniforms.kernelRadius.value=1,this.separableBlurMaterial2=this.getSeperableBlurMaterial(s),this.separableBlurMaterial2.uniforms.texSize.value=new THREE.Vector2(a(i/2),a(l/2)),this.separableBlurMaterial2.uniforms.kernelRadius.value=s,this.overlayMaterial=this.getOverlayMaterial(),THREE.CopyShader===void 0&&console.error("THREE.OutlinePass relies on THREE.CopyShader");var d=THREE.CopyShader;this.copyUniforms=THREE.UniformsUtils.clone(d.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new THREE.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:d.vertexShader,fragmentShader:d.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this.fsQuad=new THREE.Pass.FullScreenQuad(null),this.tempPulseColor1=new THREE.Color,this.tempPulseColor2=new THREE.Color,this.textureMatrix=new THREE.Matrix4},THREE.OutlinePass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.OutlinePass,dispose:function(){this.renderTargetMaskBuffer.dispose(),this.renderTargetDepthBuffer.dispose(),this.renderTargetMaskDownSampleBuffer.dispose(),this.renderTargetBlurBuffer1.dispose(),this.renderTargetBlurBuffer2.dispose(),this.renderTargetEdgeBuffer1.dispose(),this.renderTargetEdgeBuffer2.dispose()},setSize:function(e,t){var o=Math.round;this.renderTargetMaskBuffer.setSize(e,t);var r=o(e/this.downSampleRatio),a=o(t/this.downSampleRatio);this.renderTargetMaskDownSampleBuffer.setSize(r,a),this.renderTargetBlurBuffer1.setSize(r,a),this.renderTargetEdgeBuffer1.setSize(r,a),this.separableBlurMaterial1.uniforms.texSize.value=new THREE.Vector2(r,a),r=o(r/2),a=o(a/2),this.renderTargetBlurBuffer2.setSize(r,a),this.renderTargetEdgeBuffer2.setSize(r,a),this.separableBlurMaterial2.uniforms.texSize.value=new THREE.Vector2(r,a)},changeVisibilityOfSelectedObjects:function(e){function t(t){t.isMesh&&(e?(t.visible=t.userData.oldVisible,delete t.userData.oldVisible):(t.userData.oldVisible=t.visible,t.visible=e))}for(var o,r=0;r<this.selectedObjects.length;r++)o=this.selectedObjects[r],o.traverse(t)},changeVisibilityOfNonSelectedObjects:function(e){function t(e){e.isMesh&&a.push(e)}function o(t){if(t.isMesh||t.isLine||t.isSprite||t.isTransformControls){for(var o,r=!1,n=0;n<a.length;n++)if(o=a[n].id,o===t.id){r=!0;break}if(!r){var l=t.visible;(!e||t.bVisible)&&(t.visible=e),t.bVisible=l}}}for(var r,a=[],n=0;n<this.selectedObjects.length;n++)r=this.selectedObjects[n],r.traverse(t);this.renderScene.traverse(o)},updateTextureMatrix:function(){this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.renderCamera.projectionMatrix),this.textureMatrix.multiply(this.renderCamera.matrixWorldInverse)},render:function(e,t,o,r,a){var n=Math.cos;if(0<this.selectedObjects.length){this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha();var i=e.autoClear;e.autoClear=!1,a&&e.context.disable(e.context.STENCIL_TEST),e.setClearColor(16777215,1);var l=this.renderScene.background;if(this.renderScene.background=null,this.renderScene.overrideMaterial=this.depthMaterial,e.setRenderTarget(this.renderTargetDepthBuffer),e.clear(),e.render(this.renderScene,this.renderCamera),this.updateTextureMatrix(),this.changeVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskMaterial,this.prepareMaskMaterial.uniforms.cameraNearFar.value=new THREE.Vector2(this.renderCamera.near,this.renderCamera.far),this.prepareMaskMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskMaterial.uniforms.textureMatrix.value=this.textureMatrix,e.setRenderTarget(this.renderTargetMaskBuffer),e.clear(),e.render(this.renderScene,this.renderCamera),this.renderScene.overrideMaterial=null,this.changeVisibilityOfNonSelectedObjects(!0),this.renderScene.background=l,this.fsQuad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetMaskBuffer.texture,e.setRenderTarget(this.renderTargetMaskDownSampleBuffer),e.clear(),this.fsQuad.render(e),this.tempPulseColor1.copy(this.visibleEdgeColor),this.tempPulseColor2.copy(this.hiddenEdgeColor),0<this.pulsePeriod){var s=(1+.25)/2+n(.01*performance.now()/this.pulsePeriod)*(1-.25)/2;this.tempPulseColor1.multiplyScalar(s),this.tempPulseColor2.multiplyScalar(s)}this.fsQuad.material=this.edgeDetectionMaterial,this.edgeDetectionMaterial.uniforms.maskTexture.value=this.renderTargetMaskDownSampleBuffer.texture,this.edgeDetectionMaterial.uniforms.texSize.value=new THREE.Vector2(this.renderTargetMaskDownSampleBuffer.width,this.renderTargetMaskDownSampleBuffer.height),this.edgeDetectionMaterial.uniforms.visibleEdgeColor.value=this.tempPulseColor1,this.edgeDetectionMaterial.uniforms.hiddenEdgeColor.value=this.tempPulseColor2,e.setRenderTarget(this.renderTargetEdgeBuffer1),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.separableBlurMaterial1,this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=THREE.OutlinePass.BlurDirectionX,this.separableBlurMaterial1.uniforms.kernelRadius.value=this.edgeThickness,e.setRenderTarget(this.renderTargetBlurBuffer1),e.clear(),this.fsQuad.render(e),this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetBlurBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=THREE.OutlinePass.BlurDirectionY,e.setRenderTarget(this.renderTargetEdgeBuffer1),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.separableBlurMaterial2,this.separableBlurMaterial2.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial2.uniforms.direction.value=THREE.OutlinePass.BlurDirectionX,e.setRenderTarget(this.renderTargetBlurBuffer2),e.clear(),this.fsQuad.render(e),this.separableBlurMaterial2.uniforms.colorTexture.value=this.renderTargetBlurBuffer2.texture,this.separableBlurMaterial2.uniforms.direction.value=THREE.OutlinePass.BlurDirectionY,e.setRenderTarget(this.renderTargetEdgeBuffer2),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.overlayMaterial,this.overlayMaterial.uniforms.maskTexture.value=this.renderTargetMaskBuffer.texture,this.overlayMaterial.uniforms.edgeTexture1.value=this.renderTargetEdgeBuffer1.texture,this.overlayMaterial.uniforms.edgeTexture2.value=this.renderTargetEdgeBuffer2.texture,this.overlayMaterial.uniforms.patternTexture.value=this.patternTexture,this.overlayMaterial.uniforms.edgeStrength.value=this.edgeStrength,this.overlayMaterial.uniforms.edgeGlow.value=this.edgeGlow,this.overlayMaterial.uniforms.usePatternTexture.value=this.usePatternTexture,a&&e.context.enable(e.context.STENCIL_TEST),e.setRenderTarget(o),this.fsQuad.render(e),e.setClearColor(this.oldClearColor,this.oldClearAlpha),e.autoClear=i}this.renderToScreen&&(this.fsQuad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=o.texture,e.setRenderTarget(null),this.fsQuad.render(e))},getPrepareMaskMaterial:function(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"varying vec4 projTexCoord;\nvarying vec4 vPosition;\nuniform mat4 textureMatrix;\nvoid main() {\n  vPosition = modelViewMatrix * vec4(position, 1.0);\n  vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n  projTexCoord = textureMatrix * worldPosition;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragmentShader:"#include <packing>\nvarying vec4 vPosition;\nvarying vec4 projTexCoord;\nuniform sampler2D depthTexture;\nuniform vec2 cameraNearFar;\nvoid main() {\n  float depth = unpackRGBAToDepth(texture2DProj(depthTexture, projTexCoord));\n  float viewZ = - DEPTH_TO_VIEW_Z(depth, cameraNearFar.x, cameraNearFar.y);\n  float depthTest = (-vPosition.z > viewZ) ? 1.0 : 0.0;\n  gl_FragColor = vec4(0.0, depthTest, 1.0, 1.0);\n}"})},getEdgeDetectionMaterial:function(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},visibleEdgeColor:{value:new THREE.Vector3(1,1,1)},hiddenEdgeColor:{value:new THREE.Vector3(1,1,1)}},vertexShader:"varying vec2 vUv;\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragmentShader:"varying vec2 vUv;\nuniform sampler2D maskTexture;\nuniform vec2 texSize;\nuniform vec3 visibleEdgeColor;\nuniform vec3 hiddenEdgeColor;\nvoid main() {\n  vec2 invSize = 1.0 / texSize;\n  vec4 uvOffset = vec4(1.0, 0.0, 0.0, 1.0) * vec4(invSize, invSize);\n  vec4 c1 = texture2D(maskTexture, vUv + uvOffset.xy);\n  vec4 c2 = texture2D(maskTexture, vUv - uvOffset.xy);\n  vec4 c3 = texture2D(maskTexture, vUv + uvOffset.yw);\n  vec4 c4 = texture2D(maskTexture, vUv - uvOffset.yw);\n  float diff1 = (c1.r - c2.r)*0.5;\n  float diff2 = (c3.r - c4.r)*0.5;\n  float d = length(vec2(diff1, diff2));\n  float a1 = min(c1.g, c2.g);\n  float a2 = min(c3.g, c4.g);\n  float visibilityFactor = min(a1, a2);\n  vec3 edgeColor = 1.0 - visibilityFactor > 0.001 ? visibleEdgeColor : hiddenEdgeColor;\n  gl_FragColor = vec4(edgeColor, 1.0) * vec4(d);\n}"})},getSeperableBlurMaterial:function(e){return new THREE.ShaderMaterial({defines:{MAX_RADIUS:e},uniforms:{colorTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},direction:{value:new THREE.Vector2(.5,.5)},kernelRadius:{value:1}},vertexShader:"varying vec2 vUv;\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragmentShader:"#include <common>\nvarying vec2 vUv;\nuniform sampler2D colorTexture;\nuniform vec2 direction;\nuniform vec2 texSize;\nuniform float kernelRadius;\nfloat gaussianPdf(in float x, in float sigma) {\n  return 0.39894 * exp(-0.5 * x * x/(sigma * sigma))/sigma;\n}\nvoid main() {\n  vec2 invSize = 1.0 / texSize;\n  float weightSum = gaussianPdf(0.0, kernelRadius);\n  vec3 diffuseSum = texture2D(colorTexture, vUv).rgb * weightSum;\n  vec2 delta = direction * invSize * kernelRadius/float(MAX_RADIUS);\n  vec2 uvOffset = delta;\n  for(int i = 1; i <= MAX_RADIUS; i ++) {\n    float w = gaussianPdf(uvOffset.x, kernelRadius);\n    vec3 sample1 = texture2D(colorTexture, vUv + uvOffset).rgb;\n    vec3 sample2 = texture2D(colorTexture, vUv - uvOffset).rgb;\n    diffuseSum += ((sample1 + sample2) * w);\n    weightSum += (2.0 * w);\n    uvOffset += delta;\n  }\n  gl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n}"})},getOverlayMaterial:function(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},edgeTexture1:{value:null},edgeTexture2:{value:null},patternTexture:{value:null},edgeStrength:{value:1},edgeGlow:{value:1},usePatternTexture:{value:0}},vertexShader:"varying vec2 vUv;\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragmentShader:"varying vec2 vUv;\nuniform sampler2D maskTexture;\nuniform sampler2D edgeTexture1;\nuniform sampler2D edgeTexture2;\nuniform sampler2D patternTexture;\nuniform float edgeStrength;\nuniform float edgeGlow;\nuniform bool usePatternTexture;\nvoid main() {\n  vec4 edgeValue1 = texture2D(edgeTexture1, vUv);\n  vec4 edgeValue2 = texture2D(edgeTexture2, vUv);\n  vec4 maskColor = texture2D(maskTexture, vUv);\n  vec4 patternColor = texture2D(patternTexture, 6.0 * vUv);\n  float visibilityFactor = 1.0 - maskColor.g > 0.0 ? 1.0 : 0.5;\n  vec4 edgeValue = edgeValue1 + edgeValue2 * edgeGlow;\n  vec4 finalColor = edgeStrength * maskColor.r * edgeValue;\n  if(usePatternTexture)\n    finalColor += + visibilityFactor * (1.0 - maskColor.r) * (1.0 - patternColor.r);\n  gl_FragColor = finalColor;\n}",blending:THREE.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0})}}),THREE.OutlinePass.BlurDirectionX=new THREE.Vector2(1,0),THREE.OutlinePass.BlurDirectionY=new THREE.Vector2(0,1),"use strict",THREE.TransformControls=function(e,t){var s=Math.round;function o(e,t){var o=t;Object.defineProperty(u,e,{get:function(){return o===void 0?t:o},set:function(t){o!==t&&(o=t,c[e]=t,d[e]=t,u.dispatchEvent({type:e+"-changed",value:t}),u.dispatchEvent(p))}}),u[e]=t,c[e]=t,d[e]=t}function r(e){var o=e.changedTouches?e.changedTouches[0]:e,r=t.getBoundingClientRect();return{x:2*((o.clientX-r.left)/r.width)-1,y:2*(-(o.clientY-r.top)/r.height)+1,button:e.button}}function a(e){u.enabled&&u.pointerHover(r(e))}function n(e){u.enabled&&(document.addEventListener("mousemove",i,!1),u.pointerHover(r(e)),u.pointerDown(r(e)))}function i(e){u.enabled&&u.pointerMove(r(e))}function l(e){u.enabled&&(document.removeEventListener("mousemove",i,!1),u.pointerUp(r(e)))}THREE.Object3D.call(this),t=t===void 0?document:t,this.visible=!1;var d=new THREE.TransformControlsGizmo;this.add(d);var c=new THREE.TransformControlsPlane;this.add(c);var u=this;o("camera",e),o("object",void 0),o("enabled",!0),o("axis",null),o("mode","translate"),o("translationSnap",null),o("rotationSnap",null),o("space","world"),o("size",1),o("dragging",!1),o("showX",!0),o("showY",!0),o("showZ",!0);var p={type:"change"},m={type:"mouseDown"},g={type:"mouseUp",mode:u.mode},f={type:"objectChange"},b=new THREE.Raycaster,y=new THREE.Vector3,h=new THREE.Vector3,v=new THREE.Quaternion,P={X:new THREE.Vector3(1,0,0),Y:new THREE.Vector3(0,1,0),Z:new THREE.Vector3(0,0,1)},x=new THREE.Vector3,T=new THREE.Vector3,S=new THREE.Vector3,E=new THREE.Vector3,M=new THREE.Vector3,w=new THREE.Vector3,C=0,k=new THREE.Vector3,O=new THREE.Quaternion,B=new THREE.Vector3,R=new THREE.Vector3,D=new THREE.Quaternion,A=new THREE.Quaternion,L=new THREE.Vector3,V=new THREE.Vector3,j=new THREE.Quaternion,N=new THREE.Vector3,z=new THREE.Vector3,Y=new THREE.Quaternion,X=new THREE.Quaternion,_=new THREE.Vector3,Z=new THREE.Vector3,F=new THREE.Vector3,G=new THREE.Quaternion,Q=new THREE.Vector3;o("worldPosition",z),o("worldPositionStart",V),o("worldQuaternion",Y),o("worldQuaternionStart",j),o("cameraPosition",k),o("cameraQuaternion",O),o("pointStart",x),o("pointEnd",T),o("rotationAxis",E),o("rotationAngle",C),o("eye",Z),t.addEventListener("mousedown",n,!1),t.addEventListener("touchstart",n,!1),t.addEventListener("mousemove",a,!1),t.addEventListener("touchmove",a,!1),t.addEventListener("touchmove",i,!1),document.addEventListener("mouseup",l,!1),t.addEventListener("touchend",l,!1),t.addEventListener("touchcancel",l,!1),t.addEventListener("touchleave",l,!1),this.dispose=function(){t.removeEventListener("mousedown",n),t.removeEventListener("touchstart",n),t.removeEventListener("mousemove",a),t.removeEventListener("touchmove",a),t.removeEventListener("touchmove",i),document.removeEventListener("mouseup",l),t.removeEventListener("touchend",l),t.removeEventListener("touchcancel",l),t.removeEventListener("touchleave",l),this.traverse(function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})},this.attach=function(e){this.object=e,this.visible=!0},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.updateMatrixWorld=function(){this.object!==void 0&&(this.object.updateMatrixWorld(),this.object.parent.matrixWorld.decompose(R,D,L),this.object.matrixWorld.decompose(z,Y,_),A.copy(D).inverse(),X.copy(Y).inverse()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(k,O,B),this.camera instanceof THREE.PerspectiveCamera?Z.copy(k).sub(z).normalize():this.camera instanceof THREE.OrthographicCamera&&Z.copy(k).normalize(),THREE.Object3D.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(e){if(void 0!==this.object&&!0!==this.dragging&&(void 0===e.button||0===e.button)){b.setFromCamera(e,this.camera);var t=b.intersectObjects(d.picker[this.mode].children,!0)[0]||!1;this.axis=t?t.object.name:null}},this.pointerDown=function(e){if(void 0!==this.object&&!0!==this.dragging&&(void 0===e.button||0===e.button)&&(0===e.button||void 0===e.button)&&null!==this.axis){b.setFromCamera(e,this.camera);var t=b.intersectObjects([c],!0)[0]||!1;if(t){var o=this.space;if("scale"===this.mode?o="local":("E"===this.axis||"XYZE"===this.axis||"XYZ"===this.axis)&&(o="world"),"local"===o&&"rotate"===this.mode){var r=this.rotationSnap;"X"===this.axis&&r&&(this.object.rotation.x=s(this.object.rotation.x/r)*r),"Y"===this.axis&&r&&(this.object.rotation.y=s(this.object.rotation.y/r)*r),"Z"===this.axis&&r&&(this.object.rotation.z=s(this.object.rotation.z/r)*r)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),F.copy(this.object.position),G.copy(this.object.quaternion),Q.copy(this.object.scale),this.object.matrixWorld.decompose(V,j,N),x.copy(t.point).sub(V)}this.dragging=!0,m.mode=this.mode,this.dispatchEvent(m)}},this.pointerMove=function(e){var t=this.axis,o=this.mode,r=this.object,a=this.space;if("scale"===o?a="local":("E"===t||"XYZE"===t||"XYZ"===t)&&(a="world"),void 0!==r&&null!==t&&!1!==this.dragging&&(void 0===e.button||0===e.button)){b.setFromCamera(e,this.camera);var n=b.intersectObjects([c],!0)[0]||!1;if(!1!==n){if(T.copy(n.point).sub(V),"translate"===o)S.copy(T).sub(x),"local"===a&&"XYZ"!==t&&S.applyQuaternion(X),-1===t.indexOf("X")&&(S.x=0),-1===t.indexOf("Y")&&(S.y=0),-1===t.indexOf("Z")&&(S.z=0),"local"===a&&"XYZ"!==t?S.applyQuaternion(G).divide(L):S.applyQuaternion(A).divide(L),r.position.copy(S).add(F),this.translationSnap&&("local"===a&&(r.position.applyQuaternion(v.copy(G).inverse()),-1!==t.search("X")&&(r.position.x=s(r.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(r.position.y=s(r.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(r.position.z=s(r.position.z/this.translationSnap)*this.translationSnap),r.position.applyQuaternion(G)),"world"===a&&(r.parent&&r.position.add(y.setFromMatrixPosition(r.parent.matrixWorld)),-1!==t.search("X")&&(r.position.x=s(r.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(r.position.y=s(r.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(r.position.z=s(r.position.z/this.translationSnap)*this.translationSnap),r.parent&&r.position.sub(y.setFromMatrixPosition(r.parent.matrixWorld))));else if("scale"===o){if(-1!==t.search("XYZ")){var i=T.length()/x.length();0>T.dot(x)&&(i*=-1),h.set(i,i,i)}else y.copy(x),h.copy(T),y.applyQuaternion(X),h.applyQuaternion(X),h.divide(y),-1===t.search("X")&&(h.x=1),-1===t.search("Y")&&(h.y=1),-1===t.search("Z")&&(h.z=1);r.scale.copy(Q).multiply(h)}else if("rotate"===o){S.copy(T).sub(x);var l=20/z.distanceTo(y.setFromMatrixPosition(this.camera.matrixWorld));"E"===t?(E.copy(Z),C=T.angleTo(x),M.copy(x).normalize(),w.copy(T).normalize(),C*=0>w.cross(M).dot(Z)?1:-1):"XYZE"===t?(E.copy(S).cross(Z).normalize(),C=S.dot(y.copy(E).cross(this.eye))*l):("X"===t||"Y"===t||"Z"===t)&&(E.copy(P[t]),y.copy(P[t]),"local"===a&&y.applyQuaternion(Y),C=S.dot(y.cross(Z).normalize())*l),this.rotationSnap&&(C=s(C/this.rotationSnap)*this.rotationSnap),this.rotationAngle=C,"local"===a&&"E"!==t&&"XYZE"!==t?(r.quaternion.copy(G),r.quaternion.multiply(v.setFromAxisAngle(E,C)).normalize()):(E.applyQuaternion(A),r.quaternion.copy(v.setFromAxisAngle(E,C)),r.quaternion.multiply(G).normalize())}this.dispatchEvent(p),this.dispatchEvent(f)}}},this.pointerUp=function(e){void 0!==e.button&&0!==e.button||(this.dragging&&null!==this.axis&&(g.mode=this.mode,this.dispatchEvent(g)),this.dragging=!1,e.button===void 0&&(this.axis=null))},this.getMode=function(){return u.mode},this.setMode=function(e){u.mode=e},this.setTranslationSnap=function(e){u.translationSnap=e},this.setRotationSnap=function(e){u.rotationSnap=e},this.setSize=function(e){u.size=e},this.setSpace=function(e){u.space=e},this.update=function(){console.warn("THREE.TransformControls: update function has been depricated.")}},THREE.TransformControls.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:THREE.TransformControls,isTransformControls:!0}),THREE.TransformControlsGizmo=function(){'use strict';var e=Math.abs,t=Math.cos,o=Math.PI;THREE.Object3D.call(this),this.type="TransformControlsGizmo";var r=new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,side:THREE.DoubleSide,fog:!1}),a=new THREE.LineBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1}),n=r.clone();n.opacity=.15;var i=r.clone();i.opacity=.33;var l=r.clone();l.color.set(16711680);var s=r.clone();s.color.set(65280);var d=r.clone();d.color.set(255);var c=r.clone();c.opacity=.25;var u=c.clone();u.color.set(16776960);var p=c.clone();p.color.set(65535);var m=c.clone();m.color.set(16711935);var g=r.clone();g.color.set(16776960);var f=a.clone();f.color.set(16711680);var b=a.clone();b.color.set(65280);var y=a.clone();y.color.set(255);var h=a.clone();h.color.set(65535);var v=a.clone();v.color.set(16711935);var P=a.clone();P.color.set(16776960);var x=a.clone();x.color.set(7895160);var T=P.clone();T.opacity=.25;var S=new THREE.CylinderBufferGeometry(0,.05,.2,12,1,!1),E=new THREE.BoxBufferGeometry(.125,.125,.125),M=new THREE.BufferGeometry;M.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var w=function(e,r){for(var a=Math.sin,n=new THREE.BufferGeometry,l=[],s=0;s<=64*r;++s)l.push(0,t(s/32*o)*e,a(s/32*o)*e);return n.addAttribute("position",new THREE.Float32BufferAttribute(l,3)),n},C={X:[[new THREE.Mesh(S,l),[1,0,0],[0,0,-o/2],null,"fwd"],[new THREE.Mesh(S,l),[1,0,0],[0,0,o/2],null,"bwd"],[new THREE.Line(M,f)]],Y:[[new THREE.Mesh(S,s),[0,1,0],null,null,"fwd"],[new THREE.Mesh(S,s),[0,1,0],[o,0,0],null,"bwd"],[new THREE.Line(M,b),null,[0,0,o/2]]],Z:[[new THREE.Mesh(S,d),[0,0,1],[o/2,0,0],null,"fwd"],[new THREE.Mesh(S,d),[0,0,1],[-o/2,0,0],null,"bwd"],[new THREE.Line(M,y),null,[0,-o/2,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.1,0),c),[0,0,0],[0,0,0]]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.295,.295),u),[.15,.15,0]],[new THREE.Line(M,P),[.18,.3,0],null,[.125,1,1]],[new THREE.Line(M,P),[.3,.18,0],[0,0,o/2],[.125,1,1]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.295,.295),p),[0,.15,.15],[0,o/2,0]],[new THREE.Line(M,h),[0,.18,.3],[0,0,o/2],[.125,1,1]],[new THREE.Line(M,h),[0,.3,.18],[0,-o/2,0],[.125,1,1]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.295,.295),m),[.15,0,.15],[-o/2,0,0]],[new THREE.Line(M,v),[.18,0,.3],null,[.125,1,1]],[new THREE.Line(M,v),[.3,0,.18],[0,-o/2,0],[.125,1,1]]]},k={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[.6,0,0],[0,0,-o/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,0,.6],[o/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.2,0),n)]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),n),[.2,.2,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),n),[0,.2,.2],[0,o/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),n),[.2,0,.2],[-o/2,0,0]]]},O={START:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.01,2),i),null,null,null,"helper"]],END:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.01,2),i),null,null,null,"helper"]],DELTA:[[new THREE.Line(function(){var e=new THREE.BufferGeometry;return e.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,1,1],3)),e}(),i),null,null,null,"helper"]],X:[[new THREE.Line(M,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new THREE.Line(M,i.clone()),[0,-1e3,0],[0,0,o/2],[1e6,1,1],"helper"]],Z:[[new THREE.Line(M,i.clone()),[0,0,-1e3],[0,-o/2,0],[1e6,1,1],"helper"]]},B={X:[[new THREE.Line(w(1,.5),f)],[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.04,0),l),[0,0,.99],null,[1,3,1]]],Y:[[new THREE.Line(w(1,.5),b),null,[0,0,-o/2]],[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.04,0),s),[0,0,.99],null,[3,1,1]]],Z:[[new THREE.Line(w(1,.5),y),null,[0,o/2,0]],[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.04,0),d),[.99,0,0],null,[1,3,1]]],E:[[new THREE.Line(w(1.25,1),T),null,[0,o/2,0]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),T),[1.17,0,0],[0,0,-o/2],[1,1,.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),T),[-1.17,0,0],[0,0,o/2],[1,1,.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),T),[0,-1.17,0],[o,0,0],[1,1,.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),T),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new THREE.Line(w(1,1),x),null,[0,o/2,0]]]},R={AXIS:[[new THREE.Line(M,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},D={X:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[0,-o/2,-o/2]]],Y:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[o/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[0,0,-o/2]]],E:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1.25,.1,2,24),n)]],XYZE:[[new THREE.Mesh(new THREE.SphereBufferGeometry(.7,10,8),n)]]},A={X:[[new THREE.Mesh(E,l),[.8,0,0],[0,0,-o/2]],[new THREE.Line(M,f),null,null,[.8,1,1]]],Y:[[new THREE.Mesh(E,s),[0,.8,0]],[new THREE.Line(M,b),null,[0,0,o/2],[.8,1,1]]],Z:[[new THREE.Mesh(E,d),[0,0,.8],[o/2,0,0]],[new THREE.Line(M,y),null,[0,-o/2,0],[.8,1,1]]],XY:[[new THREE.Mesh(E,u),[.85,.85,0],null,[2,2,.2]],[new THREE.Line(M,P),[.855,.98,0],null,[.125,1,1]],[new THREE.Line(M,P),[.98,.855,0],[0,0,o/2],[.125,1,1]]],YZ:[[new THREE.Mesh(E,p),[0,.85,.85],null,[.2,2,2]],[new THREE.Line(M,h),[0,.855,.98],[0,0,o/2],[.125,1,1]],[new THREE.Line(M,h),[0,.98,.855],[0,-o/2,0],[.125,1,1]]],XZ:[[new THREE.Mesh(E,m),[.85,0,.85],null,[2,.2,2]],[new THREE.Line(M,v),[.855,0,.98],null,[.125,1,1]],[new THREE.Line(M,v),[.98,0,.855],[0,-o/2,0],[.125,1,1]]],XYZX:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),c),[1.1,0,0]]],XYZY:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),c),[0,1.1,0]]],XYZZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),c),[0,0,1.1]]]},L={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[.5,0,0],[0,0,-o/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[0,.5,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[0,0,.5],[o/2,0,0]]],XY:[[new THREE.Mesh(E,n),[.85,.85,0],null,[3,3,.2]]],YZ:[[new THREE.Mesh(E,n),[0,.85,.85],null,[.2,3,3]]],XZ:[[new THREE.Mesh(E,n),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.2,.2,.2),n),[1.1,0,0]]],XYZY:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.2,.2,.2),n),[0,1.1,0]]],XYZZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.2,.2,.2),n),[0,0,1.1]]]},V={X:[[new THREE.Line(M,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new THREE.Line(M,i.clone()),[0,-1e3,0],[0,0,o/2],[1e6,1,1],"helper"]],Z:[[new THREE.Line(M,i.clone()),[0,0,-1e3],[0,-o/2,0],[1e6,1,1],"helper"]]},j=function(e){var t=new THREE.Object3D;for(var o in e)for(var r=e[o].length;r--;){var a=e[o][r][0].clone(),n=e[o][r][1],l=e[o][r][2],s=e[o][r][3],d=e[o][r][4];a.name=o,a.tag=d,n&&a.position.set(n[0],n[1],n[2]),l&&a.rotation.set(l[0],l[1],l[2]),s&&a.scale.set(s[0],s[1],s[2]),a.updateMatrix();var c=a.geometry.clone();c.applyMatrix(a.matrix),a.geometry=c,a.renderOrder=1/0,a.position.set(0,0,0),a.rotation.set(0,0,0),a.scale.set(1,1,1),t.add(a)}return t},N=new THREE.Vector3(0,0,0),z=new THREE.Euler,Y=new THREE.Vector3(0,1,0),X=new THREE.Vector3(0,0,0),_=new THREE.Matrix4,Z=new THREE.Quaternion,F=new THREE.Quaternion,G=new THREE.Quaternion,Q=new THREE.Vector3(1,0,0),U=new THREE.Vector3(0,1,0),H=new THREE.Vector3(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=j(C)),this.add(this.gizmo.rotate=j(B)),this.add(this.gizmo.scale=j(A)),this.add(this.picker.translate=j(k)),this.add(this.picker.rotate=j(D)),this.add(this.picker.scale=j(L)),this.add(this.helper.translate=j(O)),this.add(this.helper.rotate=j(R)),this.add(this.helper.scale=j(V)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.updateMatrixWorld=function(){var t=Math.atan2,r=this.space;"scale"===this.mode&&(r="local");var a="local"===r?this.worldQuaternion:G;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;var n=[];n=n.concat(this.picker[this.mode].children),n=n.concat(this.gizmo[this.mode].children),n=n.concat(this.helper[this.mode].children);for(var l,s=0;s<n.length;s++){l=n[s],l.visible=!0,l.rotation.set(0,0,0),l.position.copy(this.worldPosition);var d=this.worldPosition.distanceTo(this.cameraPosition);if(l.scale.set(1,1,1).multiplyScalar(d*this.size/7),"helper"===l.tag){l.visible=!1,"AXIS"===l.name?(l.position.copy(this.worldPositionStart),l.visible=!!this.axis,"X"===this.axis&&(Z.setFromEuler(z.set(0,0,0)),l.quaternion.copy(a).multiply(Z),.9<e(Y.copy(Q).applyQuaternion(a).dot(this.eye))&&(l.visible=!1)),"Y"===this.axis&&(Z.setFromEuler(z.set(0,0,o/2)),l.quaternion.copy(a).multiply(Z),.9<e(Y.copy(U).applyQuaternion(a).dot(this.eye))&&(l.visible=!1)),"Z"===this.axis&&(Z.setFromEuler(z.set(0,o/2,0)),l.quaternion.copy(a).multiply(Z),.9<e(Y.copy(H).applyQuaternion(a).dot(this.eye))&&(l.visible=!1)),"XYZE"===this.axis&&(Z.setFromEuler(z.set(0,o/2,0)),Y.copy(this.rotationAxis),l.quaternion.setFromRotationMatrix(_.lookAt(X,Y,U)),l.quaternion.multiply(Z),l.visible=this.dragging),"E"===this.axis&&(l.visible=!1)):"START"===l.name?(l.position.copy(this.worldPositionStart),l.visible=this.dragging):"END"===l.name?(l.position.copy(this.worldPosition),l.visible=this.dragging):"DELTA"===l.name?(l.position.copy(this.worldPositionStart),l.quaternion.copy(this.worldQuaternionStart),N.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),N.applyQuaternion(this.worldQuaternionStart.clone().inverse()),l.scale.copy(N),l.visible=this.dragging):(l.quaternion.copy(a),this.dragging?l.position.copy(this.worldPositionStart):l.position.copy(this.worldPosition),this.axis&&(l.visible=-1!==this.axis.search(l.name)));continue}if(l.quaternion.copy(a),"translate"===this.mode||"scale"===this.mode){var c=.99,u=.2,p=0;("X"===l.name||"XYZX"===l.name)&&e(Y.copy(Q).applyQuaternion(a).dot(this.eye))>c&&(l.scale.set(1e-10,1e-10,1e-10),l.visible=!1),("Y"===l.name||"XYZY"===l.name)&&e(Y.copy(U).applyQuaternion(a).dot(this.eye))>c&&(l.scale.set(1e-10,1e-10,1e-10),l.visible=!1),("Z"===l.name||"XYZZ"===l.name)&&e(Y.copy(H).applyQuaternion(a).dot(this.eye))>c&&(l.scale.set(1e-10,1e-10,1e-10),l.visible=!1),"XY"===l.name&&e(Y.copy(H).applyQuaternion(a).dot(this.eye))<u&&(l.scale.set(1e-10,1e-10,1e-10),l.visible=!1),"YZ"===l.name&&e(Y.copy(Q).applyQuaternion(a).dot(this.eye))<u&&(l.scale.set(1e-10,1e-10,1e-10),l.visible=!1),"XZ"===l.name&&e(Y.copy(U).applyQuaternion(a).dot(this.eye))<u&&(l.scale.set(1e-10,1e-10,1e-10),l.visible=!1),-1!==l.name.search("X")&&(Y.copy(Q).applyQuaternion(a).dot(this.eye)<p?"fwd"===l.tag?l.visible=!1:l.scale.x*=-1:"bwd"===l.tag&&(l.visible=!1)),-1!==l.name.search("Y")&&(Y.copy(U).applyQuaternion(a).dot(this.eye)<p?"fwd"===l.tag?l.visible=!1:l.scale.y*=-1:"bwd"===l.tag&&(l.visible=!1)),-1!==l.name.search("Z")&&(Y.copy(H).applyQuaternion(a).dot(this.eye)<p?"fwd"===l.tag?l.visible=!1:l.scale.z*=-1:"bwd"===l.tag&&(l.visible=!1))}else"rotate"===this.mode&&(F.copy(a),Y.copy(this.eye).applyQuaternion(Z.copy(a).inverse()),-1!==l.name.search("E")&&l.quaternion.setFromRotationMatrix(_.lookAt(this.eye,X,U)),"X"===l.name&&(Z.setFromAxisAngle(Q,t(-Y.y,Y.z)),Z.multiplyQuaternions(F,Z),l.quaternion.copy(Z)),"Y"===l.name&&(Z.setFromAxisAngle(U,t(Y.x,Y.z)),Z.multiplyQuaternions(F,Z),l.quaternion.copy(Z)),"Z"===l.name&&(Z.setFromAxisAngle(H,t(Y.y,Y.x)),Z.multiplyQuaternions(F,Z),l.quaternion.copy(Z)));l.visible=l.visible&&(-1===l.name.indexOf("X")||this.showX),l.visible=l.visible&&(-1===l.name.indexOf("Y")||this.showY),l.visible=l.visible&&(-1===l.name.indexOf("Z")||this.showZ),l.visible=l.visible&&(-1===l.name.indexOf("E")||this.showX&&this.showY&&this.showZ),l.material._opacity=l.material._opacity||l.material.opacity,l.material._color=l.material._color||l.material.color.clone(),l.material.color.copy(l.material._color),l.material.opacity=l.material._opacity,this.enabled?this.axis&&(l.name===this.axis?(l.material.opacity=1,l.material.color.lerp(new THREE.Color(1,1,1),.25)):this.axis.split("").some(function(e){return l.name===e})?(l.material.opacity=1,l.material.color.lerp(new THREE.Color(1,1,1),.25)):(l.material.opacity*=.25,l.material.color.lerp(new THREE.Color(1,1,1),.25))):(l.material.opacity*=.5,l.material.color.lerp(new THREE.Color(1,1,1),.25))}THREE.Object3D.prototype.updateMatrixWorld.call(this)}},THREE.TransformControlsGizmo.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:THREE.TransformControlsGizmo,isTransformControlsGizmo:!0}),THREE.TransformControlsPlane=function(){'use strict';THREE.Mesh.call(this,new THREE.PlaneBufferGeometry(1e5,1e5,2,2),new THREE.MeshBasicMaterial({visible:!1,wireframe:!0,side:THREE.DoubleSide,transparent:!0,opacity:.1})),this.type="TransformControlsPlane";var e=new THREE.Vector3(1,0,0),t=new THREE.Vector3(0,1,0),o=new THREE.Vector3(0,0,1),r=new THREE.Vector3,a=new THREE.Vector3,n=new THREE.Vector3,i=new THREE.Matrix4,l=new THREE.Quaternion;this.updateMatrixWorld=function(){var s=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(s="local"),e.set(1,0,0).applyQuaternion("local"===s?this.worldQuaternion:l),t.set(0,1,0).applyQuaternion("local"===s?this.worldQuaternion:l),o.set(0,0,1).applyQuaternion("local"===s?this.worldQuaternion:l),n.copy(t),this.mode){case"translate":case"scale":switch(this.axis){case"X":n.copy(this.eye).cross(e),a.copy(e).cross(n);break;case"Y":n.copy(this.eye).cross(t),a.copy(t).cross(n);break;case"Z":n.copy(this.eye).cross(o),a.copy(o).cross(n);break;case"XY":a.copy(o);break;case"YZ":a.copy(e);break;case"XZ":n.copy(o),a.copy(t);break;case"XYZ":case"E":a.set(0,0,0);}break;case"rotate":default:a.set(0,0,0);}0===a.length()?this.quaternion.copy(this.cameraQuaternion):(i.lookAt(r.set(0,0,0),a,n),this.quaternion.setFromRotationMatrix(i)),THREE.Object3D.prototype.updateMatrixWorld.call(this)}},THREE.TransformControlsPlane.prototype=Object.assign(Object.create(THREE.Mesh.prototype),{constructor:THREE.TransformControlsPlane,isTransformControlsPlane:!0}),"use strict";function UndoItem(e,t){this.perform=e,this.data=t}function UndoStack(e){this.stack=[],this.current=-1,this.self=e}UndoStack.prototype.push=function(e,t){this.current++,this.stack.splice(this.current),this.stack.push(new UndoItem(e,t))},UndoStack.prototype.undo=function(){var e;if(0<=this.current)e=this.stack[this.current],e.perform.call(this.self,!1,e.data),this.current--;else throw new Error("Already at oldest change")},UndoStack.prototype.redo=function(){var e;if(e=this.stack[this.current+1],e)e.perform.call(this.self,!0,e.data),this.current++;else throw new Error("Already at newest change")},UndoStack.prototype.canUndo=function(){return 0<=this.current},UndoStack.prototype.canRedo=function(){return this.stack[this.current+1]!==void 0},UndoStack.prototype.invalidateAll=function(){this.stack=[],this.current=-1},"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var Asset=function(){function e(t,o){_classCallCheck(this,e),this.name=t,this.root=!0===o.root,this.proto=o.proto,this.icon=o.icon,this.slotType=o.slotType,this.slots=o.slots,this.parameters=o.parameters}return _createClass(e,[{key:"getSlotNames",value:function(){return Object.keys(this.slots)}}]),e}();function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}function _possibleConstructorReturn(e,t){return t&&("object"===_typeof(t)||"function"==typeof t)?t:_assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}var AssetLibrary=function(e){function t(){var e;return _classCallCheck(this,t),e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),e.assets=[],fetch("/robot-designer/assets/assets.json").then(function(e){return e.text()}).then(function(t){return e._loadAssets(JSON.parse(t))}),e}return _inherits(t,e),_createClass(t,[{key:"getAssetByName",value:function(e){for(var t=0;t<this.assets.length;t++)if(this.assets[t].name===e)return this.assets[t]}},{key:"_loadAssets",value:function(e){var t=this;Object.keys(e).forEach(function(o){var r=e[o],a=new Asset(o,r);t.assets.push(a)}),this.notify("loaded",null)}}]),t}(Observable);function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}function _possibleConstructorReturn(e,t){return t&&("object"===_typeof(t)||"function"==typeof t)?t:_assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}var Part=function(e){function t(e){var o;return _classCallCheck(this,t),o=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),o.asset=e,o.name=e.name,o.translation=[0,0,0],o.quaternion=[0,0,0,1],o.slots={},e.getSlotNames().forEach(function(e){o.slots[e]=null}),o}return _inherits(t,e),_createClass(t,[{key:"translate",value:function(e){this.translation=e,this.notify("Translated",{translation:e})}},{key:"rotate",value:function(e){this.quaternion=e,this.notify("Rotated",{quaternion:e})}},{key:"addPart",value:function(e,t){for(var o in console.assert(!this.slots[e]),t.parent=this,this.slots[e]=t,this.notify("PartAdded",{part:t,slotName:e}),t.slots){var r=t.slots[o];r&&r._applyFooRecursively(function(e){e.parent.notify("PartAdded",{part:e,slotName:e.parent.slotName(e)})})}}},{key:"removePart",value:function(e){for(var t in this.slots)this.slots[t]===e&&(this.slots[t]=null,this.notify("PartRemoved",{part:e,slotName:t}))}},{key:"changeColor",value:function(e){this.color=e,this.notify("ColorChanged",{color:e})}},{key:"slotName",value:function e(t){for(var e in this.slots)if(this.slots[e]===t)return e;return null}},{key:"serialize",value:function(){var e={};for(var t in e.modelName=this.name,(0!==this.translation[0]||0!==this.translation[1]||0!==this.translation[2])&&(e.translation=this.translation),(0!==this.quaternion[0]||0!==this.quaternion[1]||0!==this.quaternion[2]||1!==this.quaternion[3])&&(e.quaternion=this.quaternion),"undefined"!=typeof this.color&&(e.color=this.color),e.slots={},this.slots)this.slots[t]&&(e.slots[t]=this.slots[t].serialize());return e}},{key:"webotsExport",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t="  ".repeat(e),o=this.asset.proto;for(var r in o+=" {\n",o+=t+"  translation "+translationToWebotsString(this.translation)+"\n",o+=t+"  rotation "+quaternionToWebotsString(this.quaternion)+"\n","undefined"!=typeof this.color&&(o+=t+"  color \""+this.color+"\"\n"),this.slots)this.slots[r]&&(o+=t+"  "+r+" "+this.slots[r].webotsExport(e+1));return o+=t+"}\n",o}},{key:"getAvailableSlotTypes",value:function(){var e=[];for(var t in this.slots)null===this.slots[t]?e.push(this.asset.slots[t].type):e=e.concat(this.slots[t].getAvailableSlotTypes());return e}},{key:"_applyFooRecursively",value:function(e){for(var t in e(this),this.slots){var o=this.slots[t];o&&o._applyFooRecursively(e)}}}]),t}(Observable);function quaternionToAxisAngle(e){var t=Math.acos,o=Math.sqrt,r=[0,1,0],a=2*t(e[3]),n=o(1-e[3]*e[3]);return .001>n?(r[0]=e[0],r[1]=e[1],r[2]=e[2]):(r[0]=e[0]/n,r[1]=e[1]/n,r[2]=e[2]/n),[r,a]}function quaternionToWebotsString(e){var t=quaternionToAxisAngle(e);return t[0][0]+" "+t[0][1]+" "+t[0][2]+" "+t[1]}function translationToWebotsString(e){return e[0]+" "+e[1]+" "+e[2]}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}function _possibleConstructorReturn(e,t){return t&&("object"===_typeof(t)||"function"==typeof t)?t:_assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}var Robot=function(e){function t(){var e;return _classCallCheck(this,t),e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),e.rootPart=null,e}return _inherits(t,e),_createClass(t,[{key:"hasRootPart",value:function(){return null!==this.rootPart}},{key:"addRootPart",value:function(e){for(var t in e.parent=this,this.rootPart=e,this.notify("RootPartAdded",e),e.slots){var o=e.slots[t];o&&o._applyFooRecursively(function(e){e.parent.notify("PartAdded",{part:e,slotName:e.parent.slotName(e)})})}}},{key:"removePart",value:function(){this.rootPart=null,this.notify("RootPartRemoved")}},{key:"serialize",value:function(){var e={};return this.rootPart&&(e.rootPart=this.rootPart.serialize()),e}},{key:"webotsExport",value:function(){var e="";return e+="#VRML_SIM R2019a utf8\n",e+="WorldInfo {\n",e+="  basicTimeStep 8\n",e+="}\n",e+="Viewpoint {\n",e+="  orientation -0.02 -0.96 -0.27 3.0\n",e+="  position -0.07 0.43 -0.7\n",e+="  follow \"Tinkerbots\"\n",e+="}\n",e+="TexturedBackground {\n",e+="  texture \"empty_office\"\n",e+="}\n",e+="TexturedBackgroundLight {\n",e+="  texture \"empty_office\"\n",e+="}\n",e+="Floor {\n",e+="  size 1000 1000\n",e+="}\n",this.rootPart&&(e+=this.rootPart.webotsExport()),e}},{key:"getAvailableSlotTypes",value:function(){if(null===this.rootPart)return[];var e=this.rootPart.getAvailableSlotTypes();return e=e.filter(function(e,t,o){return o.indexOf(e)===t}),e}}]),t}(Observable);function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}function _possibleConstructorReturn(e,t){return t&&("object"===_typeof(t)||"function"==typeof t)?t:_assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}var Commands=function(e){function t(){var e;return _classCallCheck(this,t),e=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),e.undoStack=new UndoStack(null),e}return _inherits(t,e),_createClass(t,[{key:"undo",value:function(){this.canUndo()&&this.undoStack.undo(),this.notify("updated",null)}},{key:"redo",value:function(){this.canRedo()&&this.undoStack.redo(),this.notify("updated",null)}},{key:"canUndo",value:function(){return this.undoStack.canUndo()}},{key:"canRedo",value:function(){return this.undoStack.canRedo()}},{key:"_pushAction",value:function(e,t){var o=e.call(this,!0,t);return this.undoStack.push(e,t),this.notify("updated",null),o}},{key:"addPart",value:function(e,t,o){var r=this;this._pushAction(function(a){a?e.addPart(t,o):(e.removePart(o),r.notify("AnyPartRemoved",null))},[])}},{key:"translatePart",value:function(e,t){var o=e.translation;this._pushAction(function(r){r?e.translate(t):e.translate(o)},[])}},{key:"rotatePart",value:function(e,t){var o=e.quaternion;this._pushAction(function(r){r?e.rotate(t):e.rotate(o)},[])}},{key:"addRootPart",value:function(e,t){var o=this;this._pushAction(function(r){r?e.addRootPart(t):(e.removePart(),o.notify("AnyPartRemoved",null))},[])}},{key:"removePart",value:function(e){var t=this,o=e.parent,r=o.slotName(e);this._pushAction(function(a){a?(o.removePart(e),t.notify("AnyPartRemoved",null)):o.addPart(r,e)},[])}},{key:"removeRootPart",value:function(e,t){var o=this;this._pushAction(function(r){r?(e.removePart(),o.notify("AnyPartRemoved",null)):e.addRootPart(t)},[]),this.notify("AnyPartRemoved",null)}},{key:"changeColor",value:function(e,t){var o=e.color;this._pushAction(function(r){r?e.changeColor(t):e.changeColor(o)},[])}}]),t}(Observable);function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var RobotController=function(){function e(t,o,r){_classCallCheck(this,e),this.assetLibrary=t,this.commands=o,this.robot=r}return _createClass(e,[{key:"addPart",value:function(e,t,o){var r=this.assetLibrary.getAssetByName(t),a=new Part(r);e&&e!==this.robot?this.commands.addPart(e,o,a):this.commands.addRootPart(this.robot,a)}},{key:"removePart",value:function(e){var t=e.parent;t&&t!==this.robot?this.commands.removePart(e):this.commands.removeRootPart(this.robot,e)}},{key:"translatePart",value:function(e,t){var o=new THREE.Vector3(e.translation[0],e.translation[1],e.translation[2]);.001<t.distanceTo(o)&&this.commands.translatePart(e,[t.x,t.y,t.z])}},{key:"rotatePart",value:function(e,t){var o=new THREE.Quaternion(e.quaternion[0],e.quaternion[1],e.quaternion[2],e.quaternion[3]);.01<t.angleTo(o)&&this.commands.rotatePart(e,[t.x,t.y,t.z,t.w])}},{key:"changeColor",value:function(e,t){t!==e.color&&this.commands.changeColor(e,t)}}]),e}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var Dragger=function(){function e(t,o){_classCallCheck(this,e),this.robotViewer=t,this.robotController=o,this.draggedPartName=null,this.draggedPart=void 0,this.slotType=null,this.ghost=new Ghost(t.scene)}return _createClass(e,[{key:"dragStart",value:function(e,t){this.draggedPart=e,this.slotType=t}},{key:"dragEnter",value:function(){this.robotViewer.slotAnchors.showSlots(this.slotType),this.ghost.addGhost(this.draggedPart)}},{key:"dragOver",value:function(e,t){var o=this.robotViewer.robotViewerElement,r=MouseEvents.convertMouseEventPositionToScreenPosition(o,e,t),a=this.robotViewer.projectScreenPositionOnSlotsAnchors(r);if(a){var n=this.robotViewer.getClosestSlot(r,this.slotType);if(n)return this.robotViewer.slotAnchors.highlight(n),void this.ghost.moveGhostToSlot(n)}a=this.robotViewer.projectScreenPositionOnFloor(r),this.ghost.moveGhostToFloor(a)}},{key:"dragLeave",value:function(){this.robotViewer.slotAnchors.hideSlots(this.robotViewer.scene),this.ghost.removeGhost()}},{key:"drop",value:function(e,t){var o=this.robotViewer.robotViewerElement,r=MouseEvents.convertMouseEventPositionToScreenPosition(o,e,t),a=this.robotViewer.getClosestSlot(r,this.slotType);if(a){var n=a;do{if(n.userData.isPartContainer){this.robotController.addPart(n.mediator.model,this.draggedPart,a.userData.slotName);break}n=n.parent}while(n)}else this.robotController.addPart(null,this.draggedPart,"");this.robotViewer.slotAnchors.hideSlots(this.robotViewer.scene),this.ghost.removeGhost()}}]),e}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var Ghost=function(){function e(t){_classCallCheck(this,e),this.scene=t,this.ghost=null}return _createClass(e,[{key:"addGhost",value:function(e){var t=this;this.ghost=new THREE.Object3D,this.ghost.userData.isGhost=!0;var o=new THREE.X3DLoader;o.load("/robot-designer/assets/models/"+e+"/model.x3d",function(e){t.ghost&&Array.isArray(e)&&0!==e.length&&(t.ghost.add(e[0]),t.ghost.traverse(function(e){e instanceof THREE.Mesh&&(e.material.transparent=!0,e.material.opacity=.5)}))}),this.scene.add(this.ghost)}},{key:"moveGhostToFloor",value:function(e){this.scene.add(this.ghost),this.ghost.position.copy(e)}},{key:"moveGhostToSlot",value:function(e){this.ghost.position.copy(new THREE.Vector3),e.add(this.ghost)}},{key:"removeGhost",value:function(){this.ghost.parent.remove(this.ghost),this.ghost=null}}]),e}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var Handle=function(){function e(t,o,r,a,n){var i=this;_classCallCheck(this,e),this.robotController=t,this.scene=a,this.mode="select",this.part=null,this.control=new THREE.TransformControls(r,o),this.control.isTransformControls=!0,this.control.visible=!1,this.control.enabled=!1,this.control.setSpace("local"),this.control.addEventListener("dragging-changed",function(e){n.enabled=!e.value}),this.control.addEventListener("change",function(){if(i.target){if(i.part&&"translate"===i.mode){var e=i.target.position;i.robotController.translatePart(i.part,e)}if(i.part&&"rotate"===i.mode){var t=i.target.quaternion;i.robotController.rotatePart(i.part,t)}}})}return _createClass(e,[{key:"attachToObject",value:function(e){var t=this;this.detach(),this.part=e.mediator.model,this.part.addObserver("Translated",function(){t._updateTargetPosition()}),this.part.addObserver("Rotated",function(){t._updateTargetPosition()}),this.target=new THREE.Object3D,this.target.userData.isHandleTarget=!0,this._updateTargetPosition(),e.parent.add(this.target),this.control.attach(this.target),this.setMode(this.mode)}},{key:"setMode",value:function(e){this.mode=e,"select"===e?(this.control.visible=!1,this.control.enabled=!1):"translate"===e?(this.control.visible=!0,this.control.enabled=!0,this.control.setMode("translate")):"rotate"==e&&(this.control.visible=!0,this.control.enabled=!0,this.control.setMode("rotate")),this._updateConstraints()}},{key:"detach",value:function(){this.control.detach(),this.target&&(this.target.parent.remove(this.target),this.target=null),this.part=null}},{key:"showHandle",value:function(){this.scene.add(this.control)}},{key:"hideHandle",value:function(){this.scene.remove(this.control)}},{key:"isDragging",value:function(){return this.control.dragging}},{key:"_updateTargetPosition",value:function(){this.target&&(this.target.position.copy(new THREE.Vector3(this.part.translation[0],this.part.translation[1],this.part.translation[2])),this.target.quaternion.copy(new THREE.Quaternion(this.part.quaternion[0],this.part.quaternion[1],this.part.quaternion[2],this.part.quaternion[3])),this.target.updateMatrix())}},{key:"_updateConstraints",value:function(){if(this.part){var e=this.part.parent;if(console.assert(e),"select"!==this.mode){if(e instanceof Robot)return this.control.rotationSnap=null,this.control.translationSnap=null,this.control.showX=!0,this.control.showY=!0,void(this.control.showZ=!0);if(e instanceof Part){var t=e.slotName(this.part);if(t){var o=e.asset.slots[t];if(this.control.rotationSnap=-1===o.rotationSnap?null:o.rotationSnap,this.control.translationSnap=-1===o.translationSnap?null:o.translationSnap,"rotate"===this.mode)return void(0===this.control.rotationSnap?(this.control.showX=!1,this.control.showY=!1,this.control.showZ=!1):void 0===o.rotationGizmoVisibility?(this.control.showX=!0,this.control.showY=!0,this.control.showZ=!0):(this.control.showX=o.rotationGizmoVisibility[0],this.control.showY=o.rotationGizmoVisibility[1],this.control.showZ=o.rotationGizmoVisibility[2]));if("translate"===this.mode)return void(0===this.control.translationSnap?(this.control.showX=!1,this.control.showY=!1,this.control.showZ=!1):void 0===o.translationHandleVisibility?(this.control.showX=!0,this.control.showY=!0,this.control.showZ=!0):(this.control.showX=o.translationHandleVisibility[0],this.control.showY=o.translationHandleVisibility[1],this.control.showZ=o.translationHandleVisibility[2]))}}}this.control.rotationSnap=null,this.control.translationSnap=null,this.control.showX=!1,this.control.showY=!1,this.control.showZ=!1}}}]),e}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var Highlightor=function(){function e(t){_classCallCheck(this,e),this.outlinePass=t}return _createClass(e,[{key:"highlight",value:function(e){var t=[];e.children.forEach(function(e){e.userData.isRepresentation&&t.push(e)}),0<t.length&&(this.outlinePass.selectedObjects=t)}},{key:"clearHighlight",value:function(){this.outlinePass.selectedObjects=[]}}]),e}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var PartMediator=function(){function e(t){var o=this;_classCallCheck(this,e),this.model=t,this.rootObject=new THREE.Object3D,this.rootObject.matrixAutoUpdate=!1,this.rootObject.mediator=this,this.rootObject.userData.isPartContainer=!0;var r="/robot-designer/assets/models/"+this.model.name+"/model.x3d",a=new THREE.X3DLoader;a.load(r,function(e){Array.isArray(e)&&0!==e.length&&(o.representation=e[0],o.representation.userData.isRepresentation=!0,o.rootObject.add(o.representation))}),this.childrenSlots={},Object.keys(this.model.asset.slots).forEach(function(e){var t=o.model.asset.slots[e],r=new THREE.Object3D;r.userData.isSlotContainer=!0,r.userData.slotType=t.type,r.userData.slotName=e;var a=convertStringToVec3(t.translation?t.translation:"0 0 0");r.position.copy(a);var n=convertStringToQuaternion(t.rotation?t.rotation:"0 1 0 0");r.quaternion.copy(n),o.rootObject.add(r),o.childrenSlots[e]=r}),this.model.addObserver("PartAdded",function(e){return o.onPartAdded(e)}),this.model.addObserver("PartRemoved",function(e){return o.onPartRemoved(e)}),this.model.addObserver("Translated",function(e){return o.onTranslated(e)}),this.model.addObserver("Rotated",function(e){return o.onRotated(e)}),this.model.addObserver("ColorChanged",function(e){return o.onColorChanged(e)}),this.onTranslated({translation:this.model.translation}),this.onRotated({quaternion:this.model.quaternion}),"undefined"!=typeof this.model.color&&this.onColorChanged({color:this.model.color})}return _createClass(e,[{key:"onPartAdded",value:function(t){var o=new e(t.part);this.childrenSlots[t.slotName].add(o.rootObject)}},{key:"onPartRemoved",value:function(e){for(var t,o=this.childrenSlots[e.slotName].children.length-1;0<=o;o--)t=this.childrenSlots[e.slotName].children[o],t.userData.isPartContainer?t.parent.remove(t):console.assert(t.userData.isHandleTarget)}},{key:"onTranslated",value:function(e){var t=new THREE.Vector3(e.translation[0],e.translation[1],e.translation[2]);this.rootObject.position.copy(t),this.rootObject.updateMatrix()}},{key:"onRotated",value:function(e){var t=new THREE.Quaternion(e.quaternion[0],e.quaternion[1],e.quaternion[2],e.quaternion[3]);this.rootObject.quaternion.copy(t),this.rootObject.updateMatrix()}},{key:"onColorChanged",value:function(e){this.representation&&this.representation.traverse(function(t){t.isMesh&&("yellow"===e.color?t.material.color=new THREE.Color("rgb(100%, 60%, 0%)"):"blue"===e.color&&(t.material.color=new THREE.Color("rgb(0%, 45%, 100%)")))})}}]),e}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var RobotMediator=function(){function e(t){var o=this;_classCallCheck(this,e),this.model=t,this.rootObject=new THREE.Object3D,this.rootObject.name="robot",this.rootObject.model=this,this.rootObject.matrixAutoUpdate=!1,this.rootObject.mediator=this,this.model.addObserver("RootPartAdded",function(t){return o.onRootPartAdded(t)}),this.model.addObserver("RootPartRemoved",function(t){return o.onRootPartRemoved(t)})}return _createClass(e,[{key:"onRootPartAdded",value:function(e){this.rootPartMediator=new PartMediator(e),this.rootObject.add(this.rootPartMediator.rootObject)}},{key:"onRootPartRemoved",value:function(){this.rootObject.remove(this.rootPartMediator.rootObject),this.rootPartMediator=null}}]),e}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var PartBrowser=function(){function e(t,o){_classCallCheck(this,e),this.assetLibraryElement=t,this.assetLibrary=o,this.partIconDivs=[]}return _createClass(e,[{key:"loadAssets",value:function(){var e=this;this.assetLibrary.assets.forEach(function(t){var o=document.createElement("div");o.innerHTML=t.root?"<div class=\"part-icon\" draggable=\"true\" ondragstart=\"dragStart(event)\" part=\""+t.name+"\" ><img draggable=\"false\" src=\""+t.icon+"\" /></div>":"<div class=\"part-icon hidden\" draggable=\"true\" ondragstart=\"dragStart(event)\" part=\""+t.name+"\" slotType=\""+t.slotType+"\"><img draggable=\"false\" src=\""+t.icon+"\" /></div>",e.partIconDivs.push(o.firstChild),e.assetLibraryElement.appendChild(o.firstChild)})}},{key:"update",value:function(e){for(var t,o=e.getAvailableSlotTypes(),r=0;r<this.partIconDivs.length;r++)t=this.partIconDivs[r],0===o.length?t.getAttribute("slotType")?t.classList.add("hidden"):t.classList.remove("hidden"):(t.classList.remove("hidden"),t.getAttribute("slotType")?-1<o.indexOf(t.getAttribute("slotType"))?(t.classList.remove("part-icon-disabled"),t.draggable=!0):(t.classList.add("part-icon-disabled"),t.draggable=!1):t.classList.add("hidden"))}}]),e}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var PartViewer=function(){function e(t,o,r){var a=this;_classCallCheck(this,e),this.robotController=t,this.element=o,r.addObserver("SelectionChanged",function(e){return a._showPart(e.part)}),this._cleanupDiv("No selection")}return _createClass(e,[{key:"_showPart",value:function(e){if(null===e)this._cleanupDiv("No selection");else{var t=e.mediator.model,o=t.asset;this._populateDiv(t,o.parameters)}}},{key:"_populateDiv",value:function(e,t){var o=this;this.element.innerHTML="";var r=document.createElement("p");r.innerHTML="Name: <span class=\"part-name-label\">"+e.name+"</span>",this.element.appendChild(r);var a=document.createElement("p");if(!t)return a.innerHTML="<i>No parameters<i>",void this.element.appendChild(a);var n=document.createElement("form");if("color"in t){a.style.display="inline";var i=document.createTextNode("Color: ");a.appendChild(i),n.appendChild(a);var l=document.createElement("select");for(var s in l.style.display="inline",t.color){var d=document.createElement("option"),c=document.createTextNode(t.color[s]),u=document.createAttribute("value");u.value=t.color[s],d.setAttributeNode(u),d.appendChild(c),l.appendChild(d)}l.addEventListener("change",function(t){var r=t.target.value;o.robotController.changeColor(e,r)}),n.appendChild(l)}this.element.appendChild(n)}},{key:"_cleanupDiv",value:function(e){this.element.innerHTML="<p><i>"+e+"</i></p>"}}]),e}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var RobotViewer=function(){var t=Math.PI;function e(t,o,r){var a=this;_classCallCheck(this,e),this.robotViewerElement=t,this.robotController=o,this.renderer=new THREE.WebGLRenderer({antialias:!1}),this.renderer.setClearColor(0,1),this.renderer.gammaInput=!1,this.renderer.gammaOutput=!1,this.renderer.physicallyCorrectLights=!0,this.scene=new THREE.Scene,this.scene.background=new THREE.Color(0,0,0),this.camera=new THREE.PerspectiveCamera(45,.3,.001,100),this.camera.position.x=.1,this.camera.position.y=.1,this.camera.position.z=.1,this.camera.lookAt(this.scene.position);var n=new THREE.DirectionalLight(16777215,1.8);n.userData={x3dType:"DirectionalLight"},this.scene.add(n);var i=new THREE.AmbientLight(4210752);this.scene.add(i);var l=new THREE.GridHelper(5,50,8913032,4456516);l.matrixAutoUpdate=!1,this.scene.add(l),this.controls=new THREE.OrbitControls(this.camera,this.robotViewerElement),this.composer=new THREE.EffectComposer(this.renderer);var s=new THREE.RenderPass(this.scene,this.camera);this.composer.addPass(s),this.hdrResolvePass=new THREE.ShaderPass(THREE.HDRResolveShader),this.composer.addPass(this.hdrResolvePass);var d=new THREE.ShaderPass(THREE.FXAAShader);this.composer.addPass(d),this.highlightOutlinePass=new THREE.OutlinePass(new THREE.Vector2(window.innerWidth,window.innerHeight),this.scene,this.camera),this.composer.addPass(this.highlightOutlinePass),this.selectionOutlinePass=new THREE.OutlinePass(new THREE.Vector2(window.innerWidth,window.innerHeight),this.scene,this.camera),this.selectionOutlinePass.visibleEdgeColor.set(49151),this.selectionOutlinePass.renderToScreen=!0,this.composer.addPass(this.selectionOutlinePass),window.onresize=function(){return a.resize()},this.robotViewerElement.appendChild(this.renderer.domElement),this.resize(),this.highlightor=new Highlightor(this.highlightOutlinePass),this.selector=new PartSelector(this.selectionOutlinePass),this.handle=new Handle(this.robotController,this.robotViewerElement,this.camera,this.scene,this.controls),r.addObserver("AnyPartRemoved",function(){return a.clearSelection()}),this.gpuPicker=new THREE.GPUPicker({renderer:this.renderer,debug:!1}),this.gpuPicker.setFilter(function(e){return e instanceof THREE.Mesh&&"x3dType"in e.userData}),this.slotAnchors=new SlotAnchors(this.scene),this.resize()}return _createClass(e,[{key:"render",value:function(){var e=this;requestAnimationFrame(function(){return e.render()}),this.composer.render()}},{key:"resize",value:function(){var e=this.robotViewerElement.clientWidth,t=this.robotViewerElement.clientHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.gpuPicker&&this.gpuPicker.resizeTexture(e,t),this.renderer.setSize(e,t),this.composer.setSize(e,t),this.render()}},{key:"getClosestSlot",value:function(e,t){var o=Number.POSITIVE_INFINITY,r=new THREE.Raycaster;r.setFromCamera(e,this.camera);var a=r.ray,n=null,i=o,l=this.scene.getObjectByName("robot");if(l)return l.traverse(function(e){if(e.userData.isSlotContainer&&e.userData.slotType===t){var o=e,r=o.localToWorld(new THREE.Vector3),l=a.distanceSqToPoint(r);i>l&&(n=o,i=l)}}),n}},{key:"projectScreenPositionOnFloor",value:function(e){var o=new THREE.Raycaster;o.setFromCamera(e,this.camera);var r=new THREE.Mesh(new THREE.PlaneGeometry(100,100));r.geometry.rotateX(-t/2);var a=new THREE.Mesh(new THREE.PlaneGeometry(100,100));a.geometry.rotateX(t/2);var n=o.intersectObjects([r,a]);if(0<n.length)return n[0].point}},{key:"projectScreenPositionOnSlotsAnchors",value:function(e){var t=new THREE.Raycaster;t.setFromCamera(e,this.camera);var o=t.intersectObjects(this.slotAnchors.slots());if(0<o.length)return o[0].point}},{key:"getPartAt",value:function(e,t){if(!this.handle.control.pointerHover(t)){this.handle.hideHandle(),this.gpuPicker.setScene(this.scene),this.gpuPicker.setCamera(this.camera);var o=new THREE.Raycaster;o.setFromCamera(t,this.camera);var r=this.gpuPicker.pick(e,o);if(r&&0<r.faceIndex){var a=r.object;do{if(a.userData.isPartContainer)return this.handle.showHandle(),a;a=a.parent}while(a)}this.handle.showHandle()}}},{key:"clearSelection",value:function(){this.selector.clearSelection(),this.handle.detach()}}]),e}();function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}function _possibleConstructorReturn(e,t){return t&&("object"===_typeof(t)||"function"==typeof t)?t:_assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}var PartSelector=function(e){function t(e){var o;return _classCallCheck(this,t),o=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)),o.outlinePass=e,o.selectedPart=null,o}return _inherits(t,e),_createClass(t,[{key:"selectPart",value:function(e){var t=[];e.children.forEach(function(e){e.userData.isRepresentation&&t.push(e)}),0<t.length&&(this.selectedPart=e,this.outlinePass.selectedObjects=t,this.notify("SelectionChanged",{part:this.selectedPart}))}},{key:"clearSelection",value:function(){this.selectedPart=null,this.outlinePass.selectedObjects=[],this.notify("SelectionChanged",{part:null})}}]),t}(Observable);function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var SlotAnchors=function(){function e(t){_classCallCheck(this,e),this.scene=t,this.slotRepresentation=new THREE.BoxGeometry(.011,.011,.011),this.regularMaterial=new THREE.MeshBasicMaterial({color:1113904,transparent:!0,opacity:.8}),this.highlightedMaterial=new THREE.MeshBasicMaterial({color:16639,transparent:!0,opacity:.8}),this.slotRepresentationList=[],this.highlightedMesh=null}return _createClass(e,[{key:"showSlots",value:function(e){var t=this;this.hideSlots(),this.scene.traverse(function(o){if(o.userData.isSlotContainer&&o.userData.slotType===e&&0===o.children.length){var r=new THREE.Mesh(t.slotRepresentation,t.regularMaterial);r.userData.isSlotRepresentation=!0,r.matrixAutoUpdate=!1,r.name="slot representation",o.add(r),t.slotRepresentationList.push(r)}})}},{key:"slots",value:function(){return this.slotRepresentationList}},{key:"hideSlots",value:function(){this.unhighlight(),this.slotRepresentationList.forEach(function(e){e.parent.remove(e)}),this.slotRepresentationList=[]}},{key:"highlight",value:function(e){this.unhighlight();var t=e.getObjectByName("slot representation");t&&(t.material=this.highlightedMaterial,this.highlightedMesh=t)}},{key:"unhighlight",value:function(){this.highlightedMesh&&(this.highlightedMesh.material=this.regularMaterial,this.highlightedMesh=null)}}]),e}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o,r=0;r<t.length;r++)o=t[r],o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}var RobotDesigner=function(){function e(t,o,r,a,n,i){var l=this;return(_classCallCheck(this,e),this.part=t,this.undoButton=o,this.redoButton=r,this.selectButton=a,this.translateButton=n,this.rotateButton=i,"undefined"==typeof t)?void console.error("The Robot Designer is initialized on an undefined part."):(this.robotViewerElement=document.getElementsByName("robotViewer")[0],"undefined"==typeof this.robotViewerElement)?void console.error("The Robot Designer cannot find its 3D component."):(this.assetLibraryElement=document.getElementsByName("assets-library-component")[0],"undefined"==typeof this.assetLibraryElement)?void console.error("The Robot Designer cannot find its asset library component."):(this.partViewerElement=document.getElementsByName("part-viewer")[0],"undefined"==typeof this.partViewerElement?void console.error("The Robot Designer cannot find its part viewer component."):void(this.assetLibrary=new AssetLibrary,this.partBrowser=new PartBrowser(this.assetLibraryElement,this.assetLibrary),this.assetLibrary.addObserver("loaded",function(){l.partBrowser.loadAssets()}),this.commands=new Commands,this.commands.addObserver("updated",function(){return l.updateUndoRedoButtons()}),this.commands.addObserver("updated",function(){return l.partBrowser.update(l.robot)}),this.robot=new Robot,this.robotMediator=new RobotMediator(this.robot),this.robotController=new RobotController(this.assetLibrary,this.commands,this.robot),this.robotViewer=new RobotViewer(this.robotViewerElement,this.robotController,this.commands),this.robotViewer.scene.add(this.robotMediator.rootObject),this.highlightOutlinePass=this.robotViewer.highlightOutlinePass,this.dragger=new Dragger(this.robotViewer,this.robotController),this.partViewer=new PartViewer(this.robotController,this.partViewerElement,this.robotViewer.selector)))}return _createClass(e,[{key:"updateUndoRedoButtons",value:function(){this.commands.canRedo()?this.redoButton.classList.remove("fa-disabled"):this.redoButton.classList.add("fa-disabled"),this.commands.canUndo()?this.undoButton.classList.remove("fa-disabled"):this.undoButton.classList.add("fa-disabled")}}]),e}(),designer=new RobotDesigner(document.getElementById("nrp-robot-designer"),document.getElementById("nrp-robot-designer-undo-button"),document.getElementById("nrp-robot-designer-redo-button"),document.getElementById("nrp-robot-designer-select-button"),document.getElementById("nrp-robot-designer-translate-button"),document.getElementById("nrp-robot-designer-rotate-button"));function openExportModal(){var e=document.getElementById("nrp-robot-designer-modal-window");e.style.display="block";var t=document.getElementsByClassName("modal-close-button")[0];t.onclick=function(){e.style.display="none"},window.onclick=function(t){t.target===e&&(e.style.display="none")}}function exportToFile(t){var o="",r="",n="";if("json"===t)o="text/json",r=JSON.stringify(designer.robot.serialize(),null,2),n="robot.json";else if("webots"===t)o="text/txt",r=designer.robot.webotsExport(),n="robot.wbt";else return void console.assert(!1);var i=new Blob([r],{type:o}),l=document.createEvent("MouseEvents"),e=document.createElement("a");e.download=n,e.href=window.URL.createObjectURL(i),e.dataset.downloadurl=[o,e.download,e.href].join(":"),l.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),e.dispatchEvent(l)}function undo(){designer.commands.undo()}function redo(){designer.commands.redo()}function changeMode(e){designer.selectButton.classList.remove("fa-selected"),designer.translateButton.classList.remove("fa-selected"),designer.rotateButton.classList.remove("fa-selected"),"select"===e?designer.selectButton.classList.add("fa-selected"):"translate"===e?designer.translateButton.classList.add("fa-selected"):"rotate"==e&&designer.rotateButton.classList.add("fa-selected"),designer.robotViewer.handle.setMode(e)}function mouseDown(e){var t=designer.robotViewer.robotViewerElement,o=MouseEvents.convertMouseEventPositionToRelativePosition(t,e.clientX,e.clientY),r=MouseEvents.convertMouseEventPositionToScreenPosition(t,e.clientX,e.clientY);designer.partToBeSelected=designer.robotViewer.getPartAt(o,r),designer.mouseDownPosition={x:e.clientX,y:e.clientY}}function mouseUp(e){var t=Math.abs;if("undefined"!=typeof designer.partToBeSelected&&"undefined"!=typeof designer.mouseDownPosition){var o=t(designer.mouseDownPosition.x-e.clientX)+t(designer.mouseDownPosition.y-e.clientY);20>o&&(designer.robotViewer.selector.selectPart(designer.partToBeSelected),designer.robotViewer.handle.attachToObject(designer.partToBeSelected)),designer.partToBeSelected=void 0,designer.mouseDownPosition=void 0}}function deleteSelectedPart(){var e=designer.robotViewer.selector.selectedPart;if(e){var t=e;do{if(t.userData.isPartContainer){designer.robotController.removePart(t.mediator.model);break}t=t.parent}while(t)}designer.robotViewer.clearSelection()}function mouseMove(e){if(!designer.robotViewer.handle.isDragging()){var t=designer.robotViewer.robotViewerElement,o=MouseEvents.convertMouseEventPositionToRelativePosition(t,e.clientX,e.clientY),r=MouseEvents.convertMouseEventPositionToScreenPosition(t,e.clientX,e.clientY),a=designer.robotViewer.getPartAt(o,r);a?designer.robotViewer.highlightor.highlight(a):designer.robotViewer.highlightor.clearHighlight()}}function drop(e){e.preventDefault(),designer.dragger.drop(e.clientX,e.clientY)}function dragStart(e){var t=e.target.getAttribute("part"),o=e.target.getAttribute("slotType");e.dataTransfer.setData("text",t);var r=document.createElement("img");r.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",e.dataTransfer.setDragImage(r,0,0),designer.dragger.dragStart(t,o)}function dragOver(e){e.preventDefault(),e.dataTransfer.getData("text"),designer.dragger.dragOver(e.clientX,e.clientY)}function dragLeave(){designer.dragger.dragLeave()}function dragEnter(){designer.dragger.dragEnter()}